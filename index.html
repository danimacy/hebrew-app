<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Word Trainer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 16px;
    }
    .app {
      width: 100%;
      max-width: 480px;
      background: #020617;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.5);
      border: 1px solid #1f2937;
    }
    h1 {
      margin: 0 0 12px;
      font-size: 22px;
      text-align: center;
    }
    .subtitle {
      font-size: 12px;
      color: #9ca3af;
      text-align: center;
      margin-bottom: 12px;
    }
    .tabs {
      display: flex;
      margin-bottom: 12px;
      border-radius: 999px;
      background: #020617;
      border: 1px solid #111827;
      padding: 2px;
    }
    .tab {
      flex: 1;
      text-align: center;
      padding: 8px 4px;
      font-size: 13px;
      border-radius: 999px;
      border: none;
      background: transparent;
      color: #9ca3af;
      cursor: pointer;
    }
    .tab.active {
      background: #1d4ed8;
      color: #f9fafb;
      font-weight: 600;
    }
    .section { display: none; }
    .section.active { display: block; }

    textarea {
      width: 100%;
      min-height: 120px;
      border-radius: 12px;
      border: 1px solid #111827;
      background: #020617;
      color: #e5e7eb;
      padding: 8px;
      font-size: 13px;
      resize: vertical;
    }
    textarea::placeholder { color: #6b7280; }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
      margin-top: 8px;
      margin-right: 6px;
    }
    .btn-primary {
      background: #1d4ed8;
      color: #f9fafb;
    }
    .btn-secondary {
      background: #111827;
      color: #e5e7eb;
    }
    .btn-danger {
      background: #b91c1c;
      color: #fee2e2;
    }
    .btn-secondary.active {
      outline: 1px solid #1d4ed8;
    }

    .hint {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 6px;
      line-height: 1.4;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 12px;
    }
    th, td {
      border-bottom: 1px solid #111827;
      padding: 4px 2px;
    }
    th {
      text-align: left;
      color: #9ca3af;
      font-weight: 500;
    }

    .small {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 6px;
    }

    .flashcard {
      margin-top: 10px;
      padding: 20px;
      border-radius: 16px;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top, #1f2937, #020617);
      text-align: center;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .flash-main {
      font-size: 24px;
      margin-bottom: 8px;
      word-wrap: break-word;
    }
    .flash-sub {
      font-size: 16px;
      color: #9ca3af;
      word-wrap: break-word;
    }
    .flash-controls {
      margin-top: 10px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .stats {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 6px;
      text-align: center;
    }

    .quiz-card {
      margin-top: 10px;
      padding: 16px;
      border-radius: 16px;
      border: 1px solid #1f2937;
      background: #020617;
    }
    .quiz-question {
      font-size: 18px;
      margin-bottom: 10px;
      text-align: center;
    }
    .options {
      display: grid;
      grid-template-columns: 1fr;
      gap: 8px;
    }
    .option-btn {
      width: 100%;
      border-radius: 12px;
      padding: 8px;
      border: 1px solid #111827;
      background: #020617;
      color: #e5e7eb;
      font-size: 14px;
      cursor: pointer;
      text-align: left;
    }
    .option-btn.correct {
      background: #14532d;
      border-color: #16a34a;
      color: #bbf7d0;
    }
    .option-btn.wrong {
      background: #7f1d1d;
      border-color: #ef4444;
      color: #fee2e2;
    }
    .quiz-footer {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #9ca3af;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      background: #111827;
      color: #e5e7eb;
    }
    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .top-row span {
      font-size: 11px;
      color: #9ca3af;
    }

    /* –∫–∞—Ä—Ç—ã –¥–ª—è –∏–≥—Ä—ã "–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è" */
    .match-card {
      background: #020617;
      border: 1px solid #1f2937;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 14px;
    }
    .match-card:hover {
      background: #1f2937;
    }
    .match-card.selected {
      background: #1d4ed8;
      border-color: #2563eb;
      color: #f9fafb;
    }
    .match-card.correct {
      background: #14532d;
      border-color: #16a34a;
      color: #bbf7d0;
    }
    .match-card.wrong {
      background: #7f1d1d;
      border-color: #ef4444;
      color: #fee2e2;
    }

    /* –∫–æ—Ä–Ω–∏: —Å–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ */
    .roots-grid {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .root-card {
      flex: 1 1 calc(33.33% - 6px);
      min-width: 90px;
      background: #020617;
      border: 1px solid #1f2937;
      border-radius: 10px;
      padding: 6px;
      font-size: 12px;
      text-align: center;
      cursor: pointer;
      word-wrap: break-word;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .root-card:hover {
      background: #111827;
    }
    .root-card.selected {
      background: #1d4ed8;
      border-color: #2563eb;
      color: #f9fafb;
    }
    .root-card.correct {
      background: #14532d;
      border-color: #16a34a;
      color: #bbf7d0;
    }
    .root-card.wrong {
      background: #7f1d1d;
      border-color: #ef4444;
      color: #fee2e2;
    }
    .root-card.missed {
      background: #78350f;
      border-color: #fbbf24;
      color: #fef3c7;
    }
    .root-pos {
      font-size: 10px;
      color: #9ca3af;
      margin-top: 2px;
    }
    .section-divider {
      margin: 16px 0 8px;
      border-top: 1px solid #111827;
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>Word Trainer</h1>
    <div class="subtitle">–£—á–∏—Ç—å –∏–≤—Ä–∏—Ç (–∏ –Ω–µ —Ç–æ–ª—å–∫–æ) —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏</div>

    <div class="tabs">
      <button class="tab active" data-target="list">–°–ø–∏—Å–æ–∫ —Å–ª–æ–≤</button>
      <button class="tab" data-target="flashcards">–§–ª–µ—à-–∫–∞—Ä—Ç—ã</button>
      <button class="tab" data-target="quiz">–¢–µ—Å—Ç</button>
      <button class="tab" data-target="match">–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è</button>
      <button class="tab" data-target="roots">–ö–æ—Ä–Ω–∏</button>
    </div>

    <!-- –°–ï–ö–¶–ò–Ø: –°–ü–ò–°–û–ö –°–õ–û–í -->
    <div class="section active" id="section-list">
      <div class="top-row">
        <span id="total-words-label">–°–ª–æ–≤: 0</span>
        <button class="btn btn-danger" id="clear-all-btn">–°—Ç–µ—Ä–µ—Ç—å –≤—Å—ë</button>
      </div>
      <textarea id="import-text" placeholder="◊©◊ú◊ï◊ù - –ø—Ä–∏–≤–µ—Ç
◊ë◊ô◊™ - –¥–æ–º
◊û◊ô◊ù - –≤–æ–¥–∞"></textarea>
      <button class="btn btn-primary" id="import-btn">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      <div class="hint">
        –ö–∞–∂–¥—ã–π —Ä—è–¥ ‚Äî –Ω–æ–≤–æ–µ —Å–ª–æ–≤–æ.<br>
        –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å: <b>-</b> –∏–ª–∏ <b>;</b> –∏–ª–∏ —Ç–∞–±—É–ª—è—Ü–∏—è.<br>
        –°–ª–µ–≤–∞ ‚Äî –∏–≤—Ä–∏—Ç, —Å–ø—Ä–∞–≤–∞ ‚Äî –ø–µ—Ä–µ–≤–æ–¥.
      </div>

      <table id="word-table">
        <thead>
          <tr>
            <th>#</th>
            <th>–ò–≤—Ä–∏—Ç</th>
            <th>–ü–µ—Ä–µ–≤–æ–¥</th>
          </tr>
        </thead>
        <tbody id="word-tbody"></tbody>
      </table>
    </div>

    <!-- –°–ï–ö–¶–ò–Ø: –§–õ–ï–®–ö–ê–†–¢–´ -->
    <div class="section" id="section-flashcards">
      <div class="small">
        –ù–∞–∂–∏–º–∞–π ¬´–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥¬ª, –∑–∞—Ç–µ–º –æ—Ç–º–µ—á–∞–π ¬´–ó–Ω–∞—é / –ù–µ –∑–Ω–∞—é¬ª.  
        –ö–∞—Ä—Ç–æ—á–∫–∏ –∏–¥—É—Ç –≤ —Å–ª—É—á–∞–π–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.
      </div>
      <div class="flashcard" id="flashcard">
        <div class="flash-main" id="flash-front">–ù–µ—Ç —Å–ª–æ–≤ üôÉ</div>
        <div class="flash-sub" id="flash-back">–î–æ–±–∞–≤—å —Å–ª–æ–≤–∞ –≤–æ –≤–∫–ª–∞–¥–∫–µ ¬´–°–ø–∏—Å–æ–∫ —Å–ª–æ–≤¬ª</div>
      </div>
      <div class="flash-controls">
        <button class="btn btn-secondary" id="flash-toggle-btn">–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥</button>
        <button class="btn btn-primary" id="flash-next-btn">–°–ª–µ–¥—É—é—â–∞—è</button>
        <button class="btn btn-secondary" id="flash-know-btn">–ó–Ω–∞—é ‚úÖ</button>
        <button class="btn btn-secondary" id="flash-dont-know-btn">–ù–µ –∑–Ω–∞—é ‚ùå</button>
      </div>
      <div class="stats" id="flash-stats"></div>
    </div>

    <!-- –°–ï–ö–¶–ò–Ø: –¢–ï–°–¢ -->
    <div class="section" id="section-quiz">
      <div class="small">
        –í—ã–±–∏—Ä–∞–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ–¥. –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤ ‚Äî —Å–ª—É—á–∞–π–Ω—ã–µ —Å–ª–æ–≤–∞ –∏–∑ —Ç–≤–æ–µ–≥–æ —Å–ø–∏—Å–∫–∞.
      </div>
      <div class="quiz-card" id="quiz-card">
        <div class="quiz-question" id="quiz-question">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å–ª–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∞.</div>
        <div class="options" id="quiz-options"></div>
        <div class="quiz-footer">
          <span id="quiz-progress" class="badge">0 / 0</span>
          <button class="btn btn-secondary" id="next-question-btn">–î–∞–ª—å—à–µ</button>
        </div>
      </div>
    </div>

    <!-- –°–ï–ö–¶–ò–Ø: –°–û–û–¢–í–ï–¢–°–¢–í–ò–Ø -->
    <div class="section" id="section-match">
      <div class="small">
        –°–æ–µ–¥–∏–Ω–∏ —Å–ª–æ–≤–∞ –ø–æ —Å–º—ã—Å–ª—É. –ù–∞–∂–º–∏ –æ–¥–Ω–æ —Å–ª–æ–≤–æ —Å–ª–µ–≤–∞ –∏ –æ–¥–Ω–æ —Å–ø—Ä–∞–≤–∞.
      </div>

      <div id="match-area" style="margin-top: 14px;">
        <div style="display:flex; gap:16px; justify-content:space-between;">
          <div style="flex:1;">
            <h3 style="font-size:14px; margin:0 0 6px; color:#9ca3af;">–ò–≤—Ä–∏—Ç</h3>
            <div id="match-left"></div>
          </div>

          <div style="flex:1;">
            <h3 style="font-size:14px; margin:0 0 6px; color:#9ca3af;">–†—É—Å—Å–∫–∏–π</h3>
            <div id="match-right"></div>
          </div>
        </div>
      </div>

      <button class="btn btn-primary" id="match-new-btn" style="margin-top:16px;">
        –ù–æ–≤–∞—è –∏–≥—Ä–∞
      </button>
    </div>

    <!-- –°–ï–ö–¶–ò–Ø: –ö–û–†–ù–ò -->
    <div class="section" id="section-roots">
      <div class="small">
        –ó–¥–µ—Å—å –æ—Ç–¥–µ–ª—å–Ω–∞—è –±–∞–∑–∞ —Å–ª–æ–≤ –ø–æ –∫–æ—Ä–Ω—è–º. –≠—Ç–∏ —Å–ª–æ–≤–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –¥—Ä—É–≥–∏—Ö —Ä–∞–∑–¥–µ–ª–∞—Ö.
      </div>

      <h3 style="font-size:14px; margin:10px 0 4px;">–ò–º–ø–æ—Ä—Ç –∫–æ—Ä–Ω–µ–π</h3>
      <textarea id="roots-import-text" placeholder="◊†÷æ◊ß÷æ◊ñ | ◊†◊ô◊ß◊ï◊ñ [n] - –¥—Ä–µ–Ω–∞–∂
◊†÷æ◊ß÷æ◊ñ | ◊ú◊î◊™◊†◊ß◊ñ [v] - —Å—Ç–µ–∫–∞—Ç—å
◊†÷æ◊í÷æ◊ì | ◊î◊™◊†◊í◊ì◊ï◊™ [n] - —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ"></textarea>
      <button class="btn btn-primary" id="roots-import-btn">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ—Ä–Ω–∏</button>
      <div class="hint">
        –§–æ—Ä–º–∞—Ç: <b>–ö–û–†–ï–ù–¨ | —Å–ª–æ–≤–æ [–º–µ—Ç–∫–∞] - –ø–µ—Ä–µ–≤–æ–¥</b><br>
        –ú–µ—Ç–∫–∞ —á–∞—Å—Ç–∏ —Ä–µ—á–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): <b>[v]</b> ‚Äî –≥–ª–∞–≥–æ–ª, <b>[n]</b> ‚Äî —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ.<br>
        –ü—Ä–∏–º–µ—Ä:<br>
        ◊†÷æ◊ß÷æ◊ñ | ◊†◊ô◊ß◊ï◊ñ [n] - –¥—Ä–µ–Ω–∞–∂<br>
        ◊†÷æ–∫÷æ◊ñ | ◊ú◊î◊™◊†◊ß◊ñ [v] - —Å—Ç–µ–∫–∞—Ç—å<br>
        ◊†÷æ◊í÷æ◊ì | ◊î◊™◊†◊í◊ì◊ï◊™ [n] - —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ
      </div>

      <table id="roots-table">
        <thead>
          <tr>
            <th>–ö–æ—Ä–µ–Ω—å</th>
            <th>–°–ª–æ–≤</th>
            <th>–ü–æ–ø—ã—Ç–æ–∫ (–≤—Å–µ)</th>
            <th>–¢–æ—á–Ω–æ—Å—Ç—å (–≤—Å–µ)</th>
          </tr>
        </thead>
        <tbody id="roots-tbody"></tbody>
      </table>

      <div class="section-divider"></div>

      <h3 style="font-size:14px; margin:8px 0 4px;">–ò–≥—Ä–∞ –ø–æ –∫–æ—Ä–Ω—è–º</h3>
      <div class="small">
        –í—ã–±–µ—Ä–∏ –≤—Å–µ —Å–ª–æ–≤–∞ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –∫–æ—Ä–Ω–µ–º. –õ–∏—à–Ω–∏–µ —Å–ª–æ–≤–∞ –∏–∑ –¥—Ä—É–≥–∏—Ö –∫–æ—Ä–Ω–µ–π –∑–∞—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∫–∞–∫ –æ—à–∏–±–∫–∞.
      </div>

      <div class="small" style="margin-top:6px;">–†–µ–∂–∏–º —Å–ª–æ–≤:</div>
      <div class="flash-controls" id="roots-mode-controls">
        <button class="btn btn-secondary active roots-mode-btn" data-mode="all">–í—Å–µ</button>
        <button class="btn btn-secondary roots-mode-btn" data-mode="verb">–¢–æ–ª—å–∫–æ –≥–ª–∞–≥–æ–ª—ã</button>
        <button class="btn btn-secondary roots-mode-btn" data-mode="noun">–¢–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ</button>
      </div>

      <div id="roots-current-label" class="small" style="margin-top:6px;">
        –ö–æ—Ä–µ–Ω—å: ‚Äî  
      </div>

      <div id="roots-game-cards" class="roots-grid"></div>

      <div class="flash-controls">
        <button class="btn btn-secondary" id="roots-check-btn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        <button class="btn btn-primary" id="roots-new-btn">–ù–æ–≤—ã–π –∫–æ—Ä–µ–Ω—å</button>
      </div>

      <div class="stats" id="roots-game-stats"></div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "word_trainer_deck_v1";
    const ROOTS_KEY = "word_trainer_roots_v1";

    let cards = []; // –æ–±—ã—á–Ω—ã–µ —Å–ª–æ–≤–∞: {front, back}
    let flashIndex = 0;
    let flashShowBack = false;
    let flashStats = { known: 0, unknown: 0, seen: 0 };

    let quizCurrent = null; // {questionCard, options[], correctIndex}
    let quizSeen = 0;
    let quizCorrect = 0;
    let quizLocked = false;

    // --- MATCHING GAME STATE ---
    let matchPairs = [];
    let matchLeft = [];
    let matchRight = [];
    let matchSelectedLeft = null;
    let matchSelectedRight = null;

    // --- ROOTS STATE ---
    // rootGroups: [{id, label, items:[{front,back,pos}], stats:{all:{},verb:{},noun:{}}]
    let rootGroups = [];
    let rootGameCards = []; // [{id, text, isCorrect, pos}]
    let rootGameSelectedIds = new Set();
    let rootGameLocked = false;
    let rootCurrentGroup = null;
    let rootMode = "all"; // all | verb | noun

    // --- STORAGE ---
    function normalizeStats(oldStats) {
      // oldStats –º–æ–∂–µ—Ç –±—ã—Ç—å —Ñ–æ—Ä–º–∞—Ç–∞ {attempts, correct, wrong, missed} –∏–ª–∏ —É–∂–µ —Å all/verb/noun
      const empty = () => ({ attempts: 0, correct: 0, wrong: 0, missed: 0 });
      if (!oldStats || (!oldStats.all && !oldStats.verb && !oldStats.noun)) {
        const base = oldStats || {};
        return {
          all: {
            attempts: base.attempts || 0,
            correct: base.correct || 0,
            wrong: base.wrong || 0,
            missed: base.missed || 0
          },
          verb: empty(),
          noun: empty()
        };
      }
      return {
        all: Object.assign(empty(), oldStats.all || {}),
        verb: Object.assign(empty(), oldStats.verb || {}),
        noun: Object.assign(empty(), oldStats.noun || {})
      };
    }

    function loadFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          cards = [];
        } else {
          const parsed = JSON.parse(raw);
          cards = Array.isArray(parsed)
            ? parsed.filter(c => c && typeof c.front === "string" && typeof c.back === "string")
            : [];
        }
      } catch (e) {
        cards = [];
      }

      try {
        const rawRoots = localStorage.getItem(ROOTS_KEY);
        if (!rawRoots) {
          rootGroups = [];
        } else {
          const parsedRoots = JSON.parse(rawRoots);
          if (Array.isArray(parsedRoots)) {
            rootGroups = parsedRoots.map(g => ({
              id: g.id,
              label: g.label,
              items: (g.items || []).map(it => ({
                front: it.front,
                back: it.back,
                pos: it.pos || "any"
              })),
              stats: normalizeStats(g.stats)
            }));
          } else {
            rootGroups = [];
          }
        }
      } catch (e) {
        rootGroups = [];
      }
    }

    function saveWordsToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(cards));
    }
    function saveRootsToStorage() {
      localStorage.setItem(ROOTS_KEY, JSON.stringify(rootGroups));
    }

    // --- UI HELPERS ---
    function setActiveSection(id) {
      document.querySelectorAll(".section").forEach(sec => {
        sec.classList.toggle("active", sec.id === "section-" + id);
      });
      document.querySelectorAll(".tab").forEach(tab => {
        tab.classList.toggle("active", tab.dataset.target === id);
      });

      if (id === "match") {
        startMatchGame();
      }
      if (id === "roots") {
        renderRootsTable();
        startRootGame();
      }
    }

    // --- LIST SECTION (–æ–±—ã—á–Ω—ã–µ —Å–ª–æ–≤–∞) ---
    function renderTable() {
      const tbody = document.getElementById("word-tbody");
      tbody.innerHTML = "";
      cards.forEach((c, i) => {
        const tr = document.createElement("tr");
        const tdIndex = document.createElement("td");
        const tdFront = document.createElement("td");
        const tdBack = document.createElement("td");
        tdIndex.textContent = i + 1;
        tdFront.textContent = c.front;
        tdBack.textContent = c.back;
        tr.appendChild(tdIndex);
        tr.appendChild(tdFront);
        tr.appendChild(tdBack);
        tbody.appendChild(tr);
      });
      document.getElementById("total-words-label").textContent =
        "–°–ª–æ–≤: " + cards.length;
    }

    function parseImportText(text) {
      const lines = text.split(/\r?\n/);
      const newCards = [];
      for (let line of lines) {
        line = line.trim();
        if (!line) continue;
        let parts = line.split(/\t|;| - | -|- /);
        if (parts.length < 2) {
          parts = line.split(" ");
          if (parts.length >= 2) {
            const front = parts[0];
            const back = parts.slice(1).join(" ");
            newCards.push({ front: front.trim(), back: back.trim() });
          }
          continue;
        }
        const front = parts[0].trim();
        const back = parts.slice(1).join(" ").trim();
        if (front && back) {
          newCards.push({ front, back });
        }
      }
      return newCards;
    }

    function handleImport() {
      const text = document.getElementById("import-text").value;
      const imported = parseImportText(text);
      if (imported.length === 0) {
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞. –ü—Ä–æ–≤–µ—Ä—å —Ñ–æ—Ä–º–∞—Ç.");
        return;
      }
      cards = cards.concat(imported);
      saveWordsToStorage();
      renderTable();
      resetFlash();
      resetQuiz();
      startMatchGame();
      alert("–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ —Å–ª–æ–≤: " + imported.length);
    }

    function handleClearAll() {
      if (!confirm("–¢–æ—á–Ω–æ —Å—Ç–µ—Ä–µ—Ç—å –≤—Å–µ –æ–±—ã—á–Ω—ã–µ —Å–ª–æ–≤–∞?")) return;
      cards = [];
      saveWordsToStorage();
      renderTable();
      resetFlash();
      resetQuiz();
      startMatchGame();
    }

    // --- FLASHCARDS ---
    function resetFlash() {
      flashIndex = 0;
      flashShowBack = false;
      flashStats = { known: 0, unknown: 0, seen: 0 };
      updateFlashcard();
      updateFlashStats();
    }

    function randomIndex(max) {
      return Math.floor(Math.random() * max);
    }

    function pickFlashIndex() {
      if (cards.length === 0) {
        flashIndex = 0;
        return;
      }
      flashIndex = randomIndex(cards.length);
    }

    function updateFlashcard() {
      const frontEl = document.getElementById("flash-front");
      const backEl = document.getElementById("flash-back");
      const toggleBtn = document.getElementById("flash-toggle-btn");

      if (cards.length === 0) {
        frontEl.textContent = "–ù–µ—Ç —Å–ª–æ–≤ üôÉ";
        backEl.textContent = "–î–æ–±–∞–≤—å —Å–ª–æ–≤–∞ –≤–æ –≤–∫–ª–∞–¥–∫–µ ¬´–°–ø–∏—Å–æ–∫ —Å–ª–æ–≤¬ª";
        toggleBtn.disabled = true;
        document.getElementById("flash-next-btn").disabled = true;
        document.getElementById("flash-know-btn").disabled = true;
        document.getElementById("flash-dont-know-btn").disabled = true;
        return;
      }

      toggleBtn.disabled = false;
      document.getElementById("flash-next-btn").disabled = false;
      document.getElementById("flash-know-btn").disabled = false;
      document.getElementById("flash-dont-know-btn").disabled = false;

      const card = cards[flashIndex];
      if (!flashShowBack) {
        frontEl.textContent = card.front;
        backEl.textContent = "¬∑¬∑¬∑";
        toggleBtn.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥";
      } else {
        frontEl.textContent = card.front;
        backEl.textContent = card.back;
        toggleBtn.textContent = "–°–∫—Ä—ã—Ç—å –ø–µ—Ä–µ–≤–æ–¥";
      }
    }

    function updateFlashStats() {
      const s = flashStats;
      const el = document.getElementById("flash-stats");
      if (cards.length === 0) {
        el.textContent = "";
        return;
      }
      el.textContent =
        `–ü–æ–∫–∞–∑–∞–Ω–æ: ${s.seen} | –ó–Ω–∞—é: ${s.known} | –ù–µ –∑–Ω–∞—é: ${s.unknown}`;
    }

    function flashToggle() {
      if (cards.length === 0) return;
      flashShowBack = !flashShowBack;
      updateFlashcard();
    }

    function flashNext(mark) {
      if (cards.length === 0) return;
      flashStats.seen++;
      if (mark === "known") flashStats.known++;
      if (mark === "unknown") flashStats.unknown++;
      updateFlashStats();

      flashShowBack = false;
      pickFlashIndex();
      updateFlashcard();
    }

    // --- QUIZ (–æ–±—ã—á–Ω—ã–µ —Å–ª–æ–≤–∞) ---
    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    function resetQuiz() {
      quizCurrent = null;
      quizSeen = 0;
      quizCorrect = 0;
      quizLocked = false;
      buildNewQuestion();
    }

    function buildNewQuestion() {
      const questionEl = document.getElementById("quiz-question");
      const optionsEl = document.getElementById("quiz-options");
      const progressEl = document.getElementById("quiz-progress");
      const nextBtn = document.getElementById("next-question-btn");

      optionsEl.innerHTML = "";
      quizLocked = false;

      if (cards.length < 2) {
        questionEl.textContent = "–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 —Å–ª–æ–≤–∞ –¥–ª—è —Ç–µ—Å—Ç–∞.";
        nextBtn.disabled = true;
        progressEl.textContent = "0 / 0";
        return;
      }

      nextBtn.disabled = false;

      const qIndex = randomIndex(cards.length);
      const questionCard = cards[qIndex];

      const indices = [];
      for (let i = 0; i < cards.length; i++) {
        if (i !== qIndex) indices.push(i);
      }
      shuffleArray(indices);
      const wrongIndices = indices.slice(0, Math.min(3, indices.length));

      const options = [questionCard.back];
      wrongIndices.forEach(i => options.push(cards[i].back));

      shuffleArray(options);
      const correctIndex = options.indexOf(questionCard.back);

      quizCurrent = { questionCard, options, correctIndex };
      quizSeen++;

      questionEl.textContent = questionCard.front;
      options.forEach((optText, idx) => {
        const btn = document.createElement("button");
        btn.className = "option-btn";
        btn.textContent = optText;
        btn.addEventListener("click", () => handleOptionClick(idx));
        optionsEl.appendChild(btn);
      });

      progressEl.textContent = `${quizCorrect} / ${quizSeen - 1}`;
    }

    function handleOptionClick(idx) {
      if (quizLocked || !quizCurrent) return;
      quizLocked = true;
      const { correctIndex } = quizCurrent;

      const optionButtons = document.querySelectorAll(".option-btn");

      if (idx === correctIndex) {
        quizCorrect++;
      }

      optionButtons.forEach((b, i) => {
        if (i === correctIndex) {
          b.classList.add("correct");
        } else if (i === idx) {
          b.classList.add("wrong");
        }
        b.disabled = true;
      });

      const progressEl = document.getElementById("quiz-progress");
      progressEl.textContent = `${quizCorrect} / ${quizSeen}`;
    }

    function nextQuestion() {
      if (cards.length < 2) return;
      buildNewQuestion();
    }

    // --- MATCHING GAME (–æ–±—ã—á–Ω—ã–µ —Å–ª–æ–≤–∞) ---
    function startMatchGame() {
      const areaLeft = document.getElementById("match-left");
      const areaRight = document.getElementById("match-right");
      if (!areaLeft || !areaRight) return;

      areaLeft.innerHTML = "";
      areaRight.innerHTML = "";

      if (cards.length < 5) {
        areaLeft.innerHTML = "<div class='small'>–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 5 –æ–±—ã—á–Ω—ã—Ö —Å–ª–æ–≤.</div>";
        return;
      }

      const shuffled = [...cards];
      shuffleArray(shuffled);
      matchPairs = shuffled.slice(0, 5);

      matchLeft = matchPairs.map((x, i) => ({ index: i, text: x.front }));
      matchRight = matchPairs.map((x, i) => ({ index: i, text: x.back }));

      shuffleArray(matchLeft);
      shuffleArray(matchRight);

      matchSelectedLeft = null;
      matchSelectedRight = null;

      matchLeft.forEach(item => {
        const div = document.createElement("div");
        div.className = "match-card";
        div.textContent = item.text;
        div.dataset.index = item.index;
        div.onclick = () => selectLeft(div);
        areaLeft.appendChild(div);
      });

      matchRight.forEach(item => {
        const div = document.createElement("div");
        div.className = "match-card";
        div.textContent = item.text;
        div.dataset.index = item.index;
        div.onclick = () => selectRight(div);
        areaRight.appendChild(div);
      });
    }

    function selectLeft(el) {
      if (el.classList.contains("correct")) return;
      document.querySelectorAll("#match-left .match-card")
        .forEach(x => x.classList.remove("selected"));
      el.classList.add("selected");
      matchSelectedLeft = el;
      tryMatch();
    }

    function selectRight(el) {
      if (el.classList.contains("correct")) return;
      document.querySelectorAll("#match-right .match-card")
        .forEach(x => x.classList.remove("selected"));
      el.classList.add("selected");
      matchSelectedRight = el;
      tryMatch();
    }

    function tryMatch() {
      if (!matchSelectedLeft || !matchSelectedRight) return;
      const leftIndex = matchSelectedLeft.dataset.index;
      const rightIndex = matchSelectedRight.dataset.index;

      if (leftIndex === rightIndex) {
        matchSelectedLeft.classList.remove("selected");
        matchSelectedRight.classList.remove("selected");
        matchSelectedLeft.classList.add("correct");
        matchSelectedRight.classList.add("correct");
        matchSelectedLeft.onclick = null;
        matchSelectedRight.onclick = null;
      } else {
        matchSelectedLeft.classList.add("wrong");
        matchSelectedRight.classList.add("wrong");
        const l = matchSelectedLeft;
        const r = matchSelectedRight;
        setTimeout(() => {
          l.classList.remove("wrong", "selected");
          r.classList.remove("wrong", "selected");
        }, 600);
      }

      matchSelectedLeft = null;
      matchSelectedRight = null;
    }

    // --- ROOTS: –∏–º–ø–æ—Ä—Ç –∏ —Ç–∞–±–ª–∏—Ü–∞ ---
    function parseRootsImport(text) {
      const lines = text.split(/\r?\n/);
      const mapByLabel = new Map(); // label -> [{front,back,pos}]
      for (let line of lines) {
        line = line.trim();
        if (!line) continue;
        const pipeParts = line.split("|");
        if (pipeParts.length < 2) continue;
        const label = pipeParts[0].trim();
        const rest = pipeParts.slice(1).join("|").trim();
        let parts = rest.split(/\t|;| - | -|- /);
        if (parts.length < 2) continue;
        let rawFront = parts[0].trim();
        const back = parts.slice(1).join(" ").trim();
        if (!label || !rawFront || !back) continue;

        let pos = "any";
        if (/\[v\]/i.test(rawFront)) {
          pos = "verb";
          rawFront = rawFront.replace(/\[v\]/ig, "").trim();
        } else if (/\[n\]/i.test(rawFront)) {
          pos = "noun";
          rawFront = rawFront.replace(/\[n\]/ig, "").trim();
        }

        const item = { front: rawFront, back, pos };
        if (!mapByLabel.has(label)) {
          mapByLabel.set(label, []);
        }
        mapByLabel.get(label).push(item);
      }
      return mapByLabel;
    }

    function handleRootsImport() {
      const text = document.getElementById("roots-import-text").value;
      const mapByLabel = parseRootsImport(text);
      if (mapByLabel.size === 0) {
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –∫–æ—Ä–Ω–∏. –ü—Ä–æ–≤–µ—Ä—å —Ñ–æ—Ä–º–∞—Ç: –ö–û–†–ï–ù–¨ | —Å–ª–æ–≤–æ [–º–µ—Ç–∫–∞] - –ø–µ—Ä–µ–≤–æ–¥");
        return;
      }

      mapByLabel.forEach((items, label) => {
        let group = rootGroups.find(g => g.label === label);
        if (!group) {
          group = {
            id: "root_" + Date.now() + "_" + Math.random().toString(16).slice(2),
            label,
            items: [],
            stats: normalizeStats(null)
          };
          rootGroups.push(group);
        }
        group.items = group.items.concat(items);
      });

      saveRootsToStorage();
      renderRootsTable();
      startRootGame();
      alert("–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –∫–æ—Ä–Ω–µ–π: " + mapByLabel.size);
    }

    function renderRootsTable() {
      const tbody = document.getElementById("roots-tbody");
      if (!tbody) return;
      tbody.innerHTML = "";
      rootGroups.forEach(g => {
        const tr = document.createElement("tr");
        const tdLabel = document.createElement("td");
        const tdCount = document.createElement("td");
        const tdAttempts = document.createElement("td");
        const tdAcc = document.createElement("td");

        tdLabel.textContent = g.label;
        tdCount.textContent = g.items.length;
        const sAll = g.stats ? g.stats.all : { attempts: 0, correct: 0, wrong: 0, missed: 0 };
        tdAttempts.textContent = sAll.attempts || 0;

        const totalAnswers = (sAll.correct || 0) + (sAll.wrong || 0) + (sAll.missed || 0);
        if (totalAnswers === 0) {
          tdAcc.textContent = "‚Äî";
        } else {
          const acc = Math.round((sAll.correct / totalAnswers) * 100);
          tdAcc.textContent = acc + "%";
        }

        tr.appendChild(tdLabel);
        tr.appendChild(tdCount);
        tr.appendChild(tdAttempts);
        tr.appendChild(tdAcc);
        tbody.appendChild(tr);
      });
    }

    // --- ROOTS: helper –¥–ª—è —Ä–µ–∂–∏–º–∞ ---
    function wordMatchesMode(pos) {
      if (rootMode === "all") return true;
      if (!pos || pos === "any") return false;
      if (rootMode === "verb") return pos === "verb";
      if (rootMode === "noun") return pos === "noun";
      return true;
    }

    function modeLabel(mode) {
      if (mode === "verb") return "—Ç–æ–ª—å–∫–æ –≥–ª–∞–≥–æ–ª—ã";
      if (mode === "noun") return "—Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ";
      return "–≤—Å–µ —Å–ª–æ–≤–∞";
    }

    // --- ROOTS: –∏–≥—Ä–∞ ---
    function startRootGame() {
      const cardsContainer = document.getElementById("roots-game-cards");
      const labelEl = document.getElementById("roots-current-label");
      const statsEl = document.getElementById("roots-game-stats");
      if (!cardsContainer || !labelEl || !statsEl) return;

      cardsContainer.innerHTML = "";
      statsEl.textContent = "";
      rootGameSelectedIds = new Set();
      rootGameLocked = false;
      rootGameCards = [];
      rootCurrentGroup = null;

      if (!rootGroups.length) {
        labelEl.textContent = "–ö–æ—Ä–µ–Ω—å: ‚Äî (—Å–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å –∫–æ—Ä–Ω–∏ –≤—ã—à–µ)";
        return;
      }

      const gIndex = randomIndex(rootGroups.length);
      const group = rootGroups[gIndex];
      rootCurrentGroup = group;

      labelEl.textContent = "–ö–æ—Ä–µ–Ω—å: " + group.label;

      if (!group.items || group.items.length === 0) {
        cardsContainer.innerHTML = "<div class='small'>–£ —ç—Ç–æ–≥–æ –∫–æ—Ä–Ω—è –Ω–µ—Ç —Å–ª–æ–≤.</div>";
        return;
      }

      let candidates = group.items.filter(it => wordMatchesMode(it.pos));
      if (!candidates.length) {
        candidates = group.items.slice();
        statsEl.textContent = "–î–ª—è —ç—Ç–æ–≥–æ –∫–æ—Ä–Ω—è –Ω–µ—Ç —Å–ª–æ–≤ —Å –º–µ—Ç–∫–æ–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞—é –≤—Å–µ.";
      }

      const correctItems = [...candidates];
      shuffleArray(correctItems);
      const maxCorrect = Math.min(8, correctItems.length);
      const selectedCorrect = correctItems.slice(0, maxCorrect);

      const otherItems = [];
      rootGroups.forEach(g => {
        if (g === group) return;
        g.items.forEach(it => otherItems.push(it));
      });

      const distractors = [];
      if (otherItems.length) {
        let othersFiltered = otherItems.filter(it => wordMatchesMode(it.pos));
        if (!othersFiltered.length) {
          othersFiltered = otherItems.slice();
        }
        shuffleArray(othersFiltered);
        const needDistractors = Math.min(maxCorrect + 4, othersFiltered.length);
        for (let i = 0; i < needDistractors; i++) {
          distractors.push(othersFiltered[i]);
        }
      }

      const rawGameCards = [];
      selectedCorrect.forEach(it => {
        rawGameCards.push({ text: it.front, isCorrect: true, pos: it.pos });
      });
      distractors.forEach(it => {
        rawGameCards.push({ text: it.front, isCorrect: false, pos: it.pos });
      });

      shuffleArray(rawGameCards);

      rootGameCards = rawGameCards.map((c, idx) => ({
        id: idx,
        text: c.text,
        isCorrect: c.isCorrect,
        pos: c.pos
      }));

      cardsContainer.innerHTML = "";
      rootGameCards.forEach(card => {
        const div = document.createElement("div");
        div.className = "root-card";
        div.dataset.id = String(card.id);

        const main = document.createElement("div");
        main.textContent = card.text;

        div.appendChild(main);

        if (card.pos === "verb" || card.pos === "noun") {
          const posDiv = document.createElement("div");
          posDiv.className = "root-pos";
          posDiv.textContent = card.pos === "verb" ? "[v]" : "[n]";
          div.appendChild(posDiv);
        }

        div.onclick = () => onRootCardClick(div);
        cardsContainer.appendChild(div);
      });
    }

    function onRootCardClick(el) {
      if (rootGameLocked) return;
      const id = parseInt(el.dataset.id, 10);
      if (rootGameSelectedIds.has(id)) {
        rootGameSelectedIds.delete(id);
        el.classList.remove("selected");
      } else {
        rootGameSelectedIds.add(id);
        el.classList.add("selected");
      }
    }

    function checkRootGame() {
      if (rootGameLocked || !rootGameCards.length) return;
      rootGameLocked = true;
      let correct = 0;
      let wrong = 0;
      let missed = 0;

      rootGameCards.forEach(card => {
        const el = document.querySelector(".root-card[data-id='" + card.id + "']");
        if (!el) return;
        const selected = rootGameSelectedIds.has(card.id);

        if (card.isCorrect && selected) {
          correct++;
          el.classList.remove("selected");
          el.classList.add("correct");
        } else if (!card.isCorrect && selected) {
          wrong++;
          el.classList.remove("selected");
          el.classList.add("wrong");
        } else if (card.isCorrect && !selected) {
          missed++;
          el.classList.add("missed");
        }
      });

      // –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–æ—Ä–Ω—é
      if (rootCurrentGroup) {
        rootCurrentGroup.stats = normalizeStats(rootCurrentGroup.stats);
        const sAll = rootCurrentGroup.stats.all;
        const modeKey = (rootMode === "verb" || rootMode === "noun") ? rootMode : "all";
        const sMode = rootCurrentGroup.stats[modeKey];

        sAll.attempts++;
        sAll.correct += correct;
        sAll.wrong += wrong;
        sAll.missed += missed;

        if (modeKey !== "all") {
          sMode.attempts++;
          sMode.correct += correct;
          sMode.wrong += wrong;
          sMode.missed += missed;
        }

        saveRootsToStorage();
        renderRootsTable();

        const totalAnswersMode = sMode.correct + sMode.wrong + sMode.missed;
        const accMode = totalAnswersMode ? Math.round((sMode.correct / totalAnswersMode) * 100) : null;

        const statsEl = document.getElementById("roots-game-stats");
        let line1 = `–†–µ–∂–∏–º: ${modeLabel(rootMode)}. –≠—Ç–∞ –ø–æ–ø—ã—Ç–∫–∞ ‚Äî –í–µ—Ä–Ω–æ: ${correct} | –û—à–∏–±–∫–∏: ${wrong} | –ü—Ä–æ–ø—É—â–µ–Ω–æ: ${missed}.`;
        let line2 = "";
        if (accMode !== null) {
          line2 = ` –í—Å–µ–≥–æ –ø–æ —ç—Ç–æ–º—É –∫–æ—Ä–Ω—é –≤ —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ: –ø–æ–ø—ã—Ç–æ–∫ ${sMode.attempts}, —Ç–æ—á–Ω–æ—Å—Ç—å ${accMode}%.`;
        } else {
          line2 = " –í —ç—Ç–æ–º —Ä–µ–∂–∏–º–µ –ø–æ–∫–∞ –Ω–µ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ —ç—Ç–æ–º—É –∫–æ—Ä–Ω—é.";
        }
        statsEl.textContent = line1 + line2;
      } else {
        const statsEl = document.getElementById("roots-game-stats");
        statsEl.textContent =
          `–í–µ—Ä–Ω–æ: ${correct} | –û—à–∏–±–∫–∏: ${wrong} | –ü—Ä–æ–ø—É—â–µ–Ω–æ –æ–¥–Ω–æ–∫–æ—Ä–µ–Ω–Ω—ã—Ö: ${missed}`;
      }
    }

    // --- INIT ---
    function initTabs() {
      document.querySelectorAll(".tab").forEach(tab => {
        tab.addEventListener("click", () => {
          setActiveSection(tab.dataset.target);
        });
      });
    }

    function initRootsModeControls() {
      const buttons = document.querySelectorAll(".roots-mode-btn");
      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          buttons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          rootMode = btn.dataset.mode || "all";
          startRootGame();
        });
      });
    }

    function init() {
      loadFromStorage();
      renderTable();
      resetFlash();
      resetQuiz();
      startMatchGame();
      renderRootsTable();

      initTabs();
      initRootsModeControls();

      document.getElementById("import-btn").addEventListener("click", handleImport);
      document.getElementById("clear-all-btn").addEventListener("click", handleClearAll);

      document.getElementById("flash-toggle-btn").addEventListener("click", flashToggle);
      document.getElementById("flash-next-btn").addEventListener("click", () => flashNext());
      document.getElementById("flash-know-btn").addEventListener("click", () => flashNext("known"));
      document.getElementById("flash-dont-know-btn").addEventListener("click", () => flashNext("unknown"));

      document.getElementById("next-question-btn").addEventListener("click", nextQuestion);
      document.getElementById("match-new-btn").addEventListener("click", startMatchGame);

      const rootsImportBtn = document.getElementById("roots-import-btn");
      if (rootsImportBtn) {
        rootsImportBtn.addEventListener("click", handleRootsImport);
      }
      const rootsCheckBtn = document.getElementById("roots-check-btn");
      if (rootsCheckBtn) {
        rootsCheckBtn.addEventListener("click", checkRootGame);
      }
      const rootsNewBtn = document.getElementById("roots-new-btn");
      if (rootsNewBtn) {
        rootsNewBtn.addEventListener("click", startRootGame);
      }
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>